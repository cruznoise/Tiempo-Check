#  TiempoCheck ‚Äî **V2.4 (Pre‚Äërelease)**

> Preparaci√≥n para IA: *feature store*, scheduler en background, panel de estado y cimientos para an√°lisis hist√≥rico y ML.

**Estado:** Pre‚Äërelease  
**√öltima actualizaci√≥n:** 2025‚Äë08‚Äë18 (TZ: America/Mexico_City)

---

##  Resumen de esta pre‚Äërelease

Esta versi√≥n sienta los cimientos para el an√°lisis avanzado y la futura integraci√≥n de IA. Se introducen tablas de **agregados oficiales** (feature store), un **scheduler** robusto que calcula y persiste los agregados en segundo plano, y **endpoints de salud/QA** para observabilidad. El dashboard y los notebooks ahora consumen los datos **desde el feature store**, no desde CSV.

---

##  Bloques completados

###  Bloque 0 ‚Äî *Feature store* y dataset industrializado  **(CERRADO: 2025‚Äë08‚Äë14)**
- Tablas de agregados: `features_horarias` y `features_diarias` como **fuente √∫nica** para dashboard, notebooks y ML.
- Pipeline con estructura **raw/processed/logs**, limpieza autom√°tica (dominios inv√°lidos, tiempos negativos), **versionado de esquema** (`schema_ver`) y **validaciones previas** al guardar.
- Consolidaci√≥n del hist√≥rico y **exportaci√≥n** a `CSV.gz` (paralelo a BD).
- Notebooks parcheados para carga hist√≥rica y **modo DB por defecto** (no CSV).
- Normalizaci√≥n de dominios a base y ‚ÄúSin categor√≠a‚Äù.

###  Bloque 1 ‚Äî Scheduler y panel de estado  **(CERRADO: 2025‚Äë08‚Äë14)**
- Scheduler APS con `coalesce=True`, `max_instances=1`, `replace_existing=True`, protegido contra doble arranque con `WERKZEUG_RUN_MAIN`.
- **Jobs activos**:
  - `features_horarias`: cada *N* minutos (UPSERT incremental desde `registro` con *lookback*).
  - `features_diarias`: cierre diario **00:05**.
  - `features_catchup`: *catch‚Äëup* cada *N* horas.
- **Endpoints** integrados en el panel de administraci√≥n:
  - `GET /admin/api/features_estado` ‚Äî estado por usuario/d√≠a y deltas QA.
  - `GET /features_health` ‚Äî salud del scheduler y √∫ltimas ejecuciones.
  - `GET /features_qa` ‚Äî chequeos de consistencia entre horas‚Üîd√≠a.
  - `POST /admin/api/features_rebuild?dia=YYYY‚ÄëMM‚ÄëDD` ‚Äî reconstrucci√≥n puntual.
- Dashboard preparado para leer de `features_*` y seguir inyectando datasets v√≠a `data-*`.
- Extensi√≥n: env√≠o de `fecha_hora` (ISO) y persistencia en backend.

---

##  Bloques en curso / pr√≥ximos

> **Leyenda:** üü¢ Listo ¬∑ üü° En progreso ¬∑ ‚ö™ Pendiente

- **Bloque 2 ‚Äî Motor de agregados en segundo plano**: üü° *(planificaci√≥n/afinamiento)*  
  - Endurecer *catch‚Äëup*, ventanas de re‚Äëc√°lculo y control de idempotencia.  
  - Endpoint de ejecuci√≥n manual (ya existe `features_rebuild`) y CLI utilitaria.  
  - M√©tricas de latencia/recencia para cada job en `/features_health` (ampliaci√≥n).

- **Bloque 3 ‚Äî Transparencia de sugerencias**: üü°  
  - Endpoint `/api/sugerencias_detalle` y **tooltip** explicativo en UI (c√°lculo, d√≠as de respaldo y nivel de confianza).

- **Bloque 4 ‚Äî Servicio de alertas en background robusto**: üü°  
  - Daemon consolidado, canalizaci√≥n en tiempo real (**SSE/WebSocket**).  
  - Fix del bot√≥n **‚ÄúAceptar y cerrar‚Äù** de la extensi√≥n para cierre de pesta√±a.

- **Bloque 5 ‚Äî Evaluador offline de pol√≠ticas**: ‚ö™  
  - Simulador con hist√≥rico, m√©tricas y ajuste de multiplicadores/topes para metas/l√≠mites.

- **Bloque 6 ‚Äî Andamiaje ML (sin entrenar a√∫n)**: ‚ö™  
  - `pipeline.py`, `TimeSeriesSplit`, m√©tricas base, baseline sin ML y *stubs* de modelos.

- **Bloque 7 ‚Äî Monitoreo de calidad de datos**: ‚ö™  
  - Checks autom√°ticos, vista `/admin/qa_datos`, reglas de alerta y sem√°foros.

---

##  Cambios t√©cnicos relevantes (V2.4)

- **Refactor de inicializaci√≥n** de DB a `app/extensions.py` (se remove `app/db.py`).  
- **Servicios** en `app/services/` (`features_engine.py`) y **jobs** en `app/schedule/`.  
- Dashboard lee **directo** desde `features_*` (uso horario/diario y categor√≠as).  
- **An√°lisis por defecto: DB** (no CSV). RANGO por defecto: **`total`**.  
- Endpoints de estado/QA y reconstrucci√≥n puntual.  
- `.gitignore` actualizado para **excluir datasets/artefactos** (`ml/dataset/raw/`, `processed/`, `*.csv`, `*.parquet`, `*.csv.gz`) y `config.py`. Se incluye `config.example.py`.

---

##  Estructura relevante

```
app/
 ‚îú‚îÄ extensions.py                 # Init de DB (SQLAlchemy)
 ‚îú‚îÄ schedule/
 ‚îÇ   ‚îú‚îÄ scheduler.py              # Setup de jobs (APScheduler)
 ‚îÇ   ‚îî‚îÄ features_jobs.py          # Jobs horarias/diarias/catchup
 ‚îî‚îÄ services/
     ‚îî‚îÄ features_engine.py        # C√°lculo y persistencia de agregados

ml/
 ‚îú‚îÄ dataset/                      # raw/processed, validaciones y utilidades
 ‚îú‚îÄ modelos/                      # Andamiaje ML (baseline)
 ‚îî‚îÄ notebooks/                    # An√°lisis hist√≥rico (DB‚Äëfirst)

tiempocheck_extension/
 ‚îî‚îÄ background.js                 # Env√≠a fecha_hora (ISO) y eventos
```

---

##  Gu√≠a de actualizaci√≥n desde V2.3

1. **Pull + dependencias**
   ```bash
   git pull
   python -m venv venv && source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **Config**
   ```bash
   cp config.example.py config.py
   # Edita credenciales/DSN de MySQL y variables necesarias
   ```

3. **Arranque**
   ```bash
   python -m app.app
   # Verifica salud en: /features_health  y QA en: /features_qa
   ```
4. **Base de datos**
   ```bash
   -- Opcional: usa tu esquema
    -- USE tiempocheck;
    
    -- ===============================
    -- FEATURE STORE (grano hora/d√≠a)
    -- ===============================
    
    CREATE TABLE IF NOT EXISTS features_uso_hora (
      usuario_id   INT            NOT NULL,
      fecha        DATE           NOT NULL,
      hora         TINYINT UNSIGNED NOT NULL,          -- 0..23
      categoria    VARCHAR(64)    NOT NULL DEFAULT 'Sin categor√≠a',
      minutos      DECIMAL(10,2)  NOT NULL DEFAULT 0.00,
      schema_ver   TINYINT UNSIGNED NOT NULL DEFAULT 1,
      created_at   TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at   TIMESTAMP      NULL ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, fecha, hora, categoria),
      KEY idx_fuho_usuario_fecha (usuario_id, fecha),
      KEY idx_fuho_fecha (fecha),
      CONSTRAINT fk_fuho_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS features_horarias (
      usuario_id   INT            NOT NULL,
      fecha        DATE           NOT NULL,
      hora         TINYINT UNSIGNED NOT NULL,          -- 0..23
      minutos      DECIMAL(10,2)  NOT NULL DEFAULT 0.00,
      schema_ver   TINYINT UNSIGNED NOT NULL DEFAULT 1,
      created_at   TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at   TIMESTAMP      NULL ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, fecha, hora),
      KEY idx_fhor_usuario_fecha (usuario_id, fecha),
      KEY idx_fhor_fecha (fecha),
      CONSTRAINT fk_fhor_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS features_categoria_diaria (
      usuario_id   INT            NOT NULL,
      fecha        DATE           NOT NULL,
      categoria    VARCHAR(64)    NOT NULL,
      minutos      DECIMAL(10,2)  NOT NULL DEFAULT 0.00,
      schema_ver   TINYINT UNSIGNED NOT NULL DEFAULT 1,
      created_at   TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at   TIMESTAMP      NULL ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, fecha, categoria),
      KEY idx_fcdi_usuario_fecha (usuario_id, fecha),
      KEY idx_fcdi_fecha (fecha),
      KEY idx_fcdi_categoria (categoria),
      CONSTRAINT fk_fcdi_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS features_diarias (
      usuario_id   INT            NOT NULL,
      fecha        DATE           NOT NULL,
      minutos_total DECIMAL(10,2) NOT NULL DEFAULT 0.00,
      schema_ver   TINYINT UNSIGNED NOT NULL DEFAULT 1,
      created_at   TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
      updated_at   TIMESTAMP      NULL ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, fecha),
      KEY idx_fdia_fecha (fecha),
      CONSTRAINT fk_fdia_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    -- Alias de compatibilidad si alguna l√≥gica espera el nombre en plural:
    -- CREATE OR REPLACE VIEW features_uso_horaS AS SELECT * FROM features_uso_hora;
    
    -- ===============================
    -- AGREGADOS / KPI
    -- ===============================
    
    CREATE TABLE IF NOT EXISTS agg_estado_dia (
      usuario_id   INT           NOT NULL,
      fecha        DATE          NOT NULL,
      ok           BOOLEAN       NOT NULL DEFAULT 0,     -- coherencia entre horas vs diario
      detalles     JSON          NOT NULL,               -- [{categoria, diaria, horas_sum, delta}, ...]
      created_at   TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, fecha),
      KEY idx_aed_fecha (fecha),
      CONSTRAINT fk_aed_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS agg_kpi_rango (
      id           BIGINT AUTO_INCREMENT PRIMARY KEY,
      usuario_id   INT           NOT NULL,
      fecha_inicio DATE          NOT NULL,
      fecha_fin    DATE          NOT NULL,
      kpis         JSON          NOT NULL,               -- totales, promedios, % productivo vs no, etc.
      created_at   TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
      UNIQUE KEY uniq_usuario_rango (usuario_id, fecha_inicio, fecha_fin),
      KEY idx_akr_usuario (usuario_id),
      CONSTRAINT fk_akr_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    CREATE TABLE IF NOT EXISTS agg_ventana_categoria (
      usuario_id       INT           NOT NULL,
      categoria        VARCHAR(64)   NOT NULL,
      fecha_fin        DATE          NOT NULL,           -- fin de la ventana m√≥vil
      ventana_dias     SMALLINT      NOT NULL,          -- 7, 14, 30, etc.
      n_dias           SMALLINT      NOT NULL,          -- d√≠as efectivamente contados
      minutos_total    DECIMAL(10,2) NOT NULL,
      minutos_promedio DECIMAL(10,2) NOT NULL,
      minutos_min      DECIMAL(10,2) NULL,
      minutos_max      DECIMAL(10,2) NULL,
      minutos_mediana  DECIMAL(10,2) NULL,
      created_at       TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY (usuario_id, categoria, fecha_fin, ventana_dias),
      KEY idx_avc_usuario_categoria (usuario_id, categoria),
      CONSTRAINT fk_avc_usuario FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    -- ===============================
    -- VISTAS
    -- ===============================
    
    -- Estado actual por usuario/categor√≠a (hoy)
    CREATE OR REPLACE VIEW v_estado_actual_usuario AS
    SELECT
      f.usuario_id,
      f.fecha,
      f.categoria,
      f.minutos,
      t.minutos_total_dia
    FROM features_categoria_diaria AS f
    JOIN (
      SELECT usuario_id, fecha, SUM(minutos) AS minutos_total_dia
      FROM features_categoria_diaria
      GROUP BY usuario_id, fecha
    ) AS t
      ON t.usuario_id = f.usuario_id AND t.fecha = f.fecha
    WHERE f.fecha = CURRENT_DATE();
    
    -- Resumen de ventanas 7/14/30 d√≠as por usuario y categor√≠a
    CREATE OR REPLACE VIEW v_resumen_ventanas AS
    SELECT usuario_id, categoria, '7d' AS ventana,
           MIN(fecha) AS desde, MAX(fecha) AS hasta,
           COUNT(*) AS n_dias, SUM(minutos) AS minutos_total, AVG(minutos) AS minutos_promedio
    FROM features_categoria_diaria
    WHERE fecha >= CURRENT_DATE() - INTERVAL 7 DAY
    GROUP BY usuario_id, categoria
    UNION ALL
    SELECT usuario_id, categoria, '14d' AS ventana,
           MIN(fecha) AS desde, MAX(fecha) AS hasta,
           COUNT(*) AS n_dias, SUM(minutos) AS minutos_total, AVG(minutos) AS minutos_promedio
    FROM features_categoria_diaria
    WHERE fecha >= CURRENT_DATE() - INTERVAL 14 DAY
    GROUP BY usuario_id, categoria
    UNION ALL
    SELECT usuario_id, categoria, '30d' AS ventana,
           MIN(fecha) AS desde, MAX(fecha) AS hasta,
           COUNT(*) AS n_dias, SUM(minutos) AS minutos_total, AVG(minutos) AS minutos_promedio
    FROM features_categoria_diaria
    WHERE fecha >= CURRENT_DATE() - INTERVAL 30 DAY
    GROUP BY usuario_id, categoria;
    ```


5. **Extensi√≥n Chrome**
   - Carga sin comprimir la carpeta `tiempocheck_extension/`.
   - Verifica env√≠o de `fecha_hora` y que el backend lo persista.

6. **Datos & artefactos**
   - Los datasets locales quedan fuera del repo por `.gitignore`.
   - Export/backup/restauraci√≥n siguen disponibles desde el panel (si aplica).

> **Importante:** El scheduler est√° protegido contra doble arranque con `WERKZEUG_RUN_MAIN`. No lances m√∫ltiples procesos del servidor en paralelo.

---

##  Endpoints de estado / operaci√≥n

- `GET /admin/api/features_estado?usuario_id=...&dia=YYYY‚ÄëMM‚ÄëDD`  
- `GET /features_health`  
- `GET /features_qa`  
- `POST /admin/api/features_rebuild?dia=YYYY‚ÄëMM‚ÄëDD&usuario_id=...`

---

##  Pendientes conocidos (pre‚Äërelease)

- Consolidar el **nivel de confianza de sugerencias** por d√≠as de uso (0‚Äë2 oculta, 3‚Äë6 inicial, 7‚Äë14 confiable, 14+ consolidado) y el **tooltip** de transparencia.  
- Servicio de alertas en **tiempo real** (SSE/WebSocket) y **fix** del cierre de pesta√±a en la extensi√≥n.

---

##  Roadmap post‚Äëpre‚Äërelease

- Cerrar Bloque 2 y estabilizar rec√°lculos/catch‚Äëup.  
- Entregar Bloques 3‚Äì4 (transparencia y alertas robustas).  
- Comenzar Bloque 6 (andamiaje ML) y Bloque 7 (monitoreo de calidad).

---

##  Autor

**Luis √Ångel Cruz** ‚Äî ESIME Zacatenco (IPN)  
Proyecto de titulaci√≥n ‚Äî *TiempoCheck*  
Pre‚Äërelease V2.4 ¬∑ 2025‚Äë08‚Äë18
