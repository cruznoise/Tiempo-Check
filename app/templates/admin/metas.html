<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Metas y L√≠mites - ProcrastiGuard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos1.css') }}"> 
</head>
<body> 
<div class="dashboard-container">
  
  <aside class="sidebar">
    <h2>¬°Hola,<br>{{ nombre or 'Usuario' }}!</h2> 
    <p>Este es tu resumen personal</p> 
    <nav>
      <ul>
        <li><a href="{{ url_for('controlador.dashboard') }}"><img src="{{ url_for('static', filename='icons/home.png') }}" alt="Home"></a></li>
        <li><a href="{{ url_for('admin_controller.vista_metas') }}"><img src="{{ url_for('static', filename='icons/trophy.png') }}" alt="Logros"></a></li>
        <li>            <a href="#" id="btnConfiguracion">
              <img src="{{ url_for('static', filename='icons/settings.svg') }}" alt="Configuraci√≥n">
            </a></li>
      </ul>
    </nav>
    
    <div class="alerta-coach-container" id="alerta-coach-sidebar">
        <div class="alerta-coach-titulo">
            <p>Alertas del Coach</p>
        </div>
        
        <div class="loading-box" id="coach-loading-state">
            <p>Cargando</p>
            <p style="font-size: 0.8em; color: var(--accent-light);">Esperando datos del coach...</p>
        </div>
        
        <div id="coach-alerts-list">
        </div>
    </div>
  </aside>

  <main class="content">
    
    <div class="metas-limites-grid">

      <section class="tile-box logros-panel"> 
          <h3 class="section-title">Metas y logros</h3> 
          <h4 class="box-subtitle">Logros desbloqueables</h4>
          <p class="scroll-note">Con barra deslizable</p>
          <div class="logros-grid scrollable-content" id="contenedor-logros">
          </div>
      </section>



      <!-- SECCI√ìN DE SUGERENCIAS CON PREDICCIONES ML -->
      <div class="tile-box sug-limits-panel">        
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <h4 class="box-subtitle" style="margin-bottom: 0;">
                <span class="info-coach-tooltip">Sugerencias de metas del Coach
                <span class="coach-tooltip-text">
                    <b>Mecanismo de Sugerencia:</b>
                    <br>
                    El Coach utiliza un modelo de Machine Learning (ML) que predice tu uso futuro en minutos por categor√≠a.
                    <br>
                    <b>Meta Sugerida:</b><br>
                    Se basa en estas predicciones para ayudarte a establecer objetivos realistas y productivos.
                </span>
            </span></h4>
        </div>

        <div style="padding: 15px; background: var(--card); border-radius: 8px; border: 1px solid var(--accent-light);">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="categoriaSelect" style="font-weight: 600; display: block; margin-bottom: 5px;">Categor√≠a</label>
              <select id="categoriaSelect" style="width: 100%; max-width: 280px; padding: 8px; border-radius: 6px; border: 1px solid var(--accent-light); background: var(--card); color: var(--text);">
                <option value="">Selecciona una categor√≠a</option>
              </select>
            </div>
            <small id="estadoPred" style="color: var(--accent-light);">Cargando predicciones...</small>
          </div>

          <div style="margin: 15px 0;">
            <canvas id="chartPredicciones" height="130"></canvas>
          </div>

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
            <button id="btnRevision" style="padding: 8px 15px; border-radius: 6px; border: 1px solid var(--accent-light); background: transparent; color: var(--text); cursor: pointer;">
              Revisi√≥n de carga
            </button>
            <button id="btnMeta" style="padding: 8px 15px; border-radius: 6px; border: none; background: var(--accent); color: white; cursor: pointer; font-weight: 600;">
              Establecer meta para este d√≠a
            </button>
          </div>
        </div>

        <div id="coachMetaFeedback" style="margin-top: 15px; text-align: center; color: var(--accent-light); display: none;"></div>
      </div>

      <section class="tile-box add-goal-box">
        <h3>AGREGAR UNA NUEVA META DIARIA</h3>
        <form class="tile-form" action="{{ url_for('admin_controller.agregar_meta') }}" method="POST">
          <select name="usuario_id" required><option value="">Selecciona un usuario</option>{% for u in usuarios %}<option value="{{ u.id }}">{{ u.nombre }}</option>{% endfor %}</select>
          <select name="categoria_id" required><option value="">Selecciona una categor√≠a</option>{% for c in categorias %}<option value="{{ c.id }}">{{ c.nombre }}</option>{% endfor %}</select>
          <input type="number" name="limite_minutos" placeholder="L√≠mite (min)" required min="1">
          <button type="submit">Aceptar</button>
        </form>
      </section>

      <section class="tile-box metas-limits-list-box list-metas">
          <h3>METAS ESTABLECIDAS</h3>
          <div class="table-container scrollable-content">
            <table>
              <thead><tr><th>ID</th><th>Usuario</th><th>Categor√≠a</th><th>L√≠mite</th><th>Acciones</th></tr></thead>
              <tbody>
                {% for m in metas %}
                <tr>
                  <td>{{ m.id }}</td><td>{{ m.usuario.nombre }}</td><td>{{ m.categoria.nombre }}</td>
                  <td><form action="{{ url_for('admin_controller.editar_meta', id=m.id) }}" method="POST" style="display:inline-flex;"><input type="number" name="limite_minutos" value="{{ m.limite_minutos }}" required min="1" style="width: 60px;"><button type="submit" style="margin-left: 5px;">üíæ</button></form></td>
                  <td><form action="{{ url_for('admin_controller.eliminar_meta', id=m.id) }}" method="POST" style="display:inline;"><button type="submit" onclick="return confirm('¬øEliminar meta?')">üóëÔ∏è</button></form></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      </section>
      
      <section class="tile-box status-box">
          <h3>ESTADO DE METAS HOY</h3>
          <div class="table-container scrollable-content">
            <table>
              <thead><tr><th>Categor√≠a</th><th>Meta</th><th>Usado hoy</th><th>Estado</th><th>Origen</th></tr></thead>
              <tbody>
                {% for meta in estado_metas %}
                <tr>
                  <td>{{ meta.categoria }}</td><td>{{ meta.meta }}</td><td>{{ meta.usado }}</td>
                  <td>{% if meta.cumplida %}<span class="estado-verde">‚úì Cumplida</span>{% else %}<span class="estado-naranja">‚è≥ Pendiente</span>{% endif %}</td>
                  <td>
                    {% if meta.origen == 'coach' %}
                      <span class="estado-azul"> Coach</span>
                    {% elif meta.origen == 'manual' %}
                      <span class="estado-gris"> Manual</span>
                    {% elif meta.origen == 'sistema' %}
                      <span class="estado-celeste"> Sistema</span>
                    {% else %}
                      <span class="estado-gris-claro">{{ meta.origen or '‚Äî' }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      </section>

      <section class="tile-box add-limit-box">
        <h3>AGREGAR UN L√çMITE NUEVO DIARIO</h3>
        <form class="tile-form" action="{{ url_for('admin_controller.agregar_limite') }}" method="POST">
          <select name="usuario_id" required><option value="">Selecciona un usuario</option>{% for u in usuarios %}<option value="{{ u.id }}">{{ u.nombre }}</option>{% endfor %}</select>
          <select name="categoria_id" required><option value="">Selecciona una categor√≠a</option>{% for c in categorias %}<option value="{{ c.id }}">{{ c.nombre }}</option>{% endfor %}</select>
          <input type="number" name="limite_minutos" placeholder="L√≠mite (min)" required min="1">
          <button type="submit">Aceptar</button>
        </form>
      </section>

      <section class="tile-box metas-limits-list-box list-limites">
          <h3>L√çMITES ESTABLECIDOS</h3>
          <div class="table-container scrollable-content">
            <table>
              <thead><tr><th>ID</th><th>Usuario</th><th>Categor√≠a</th><th>L√≠mite</th><th>Acciones</th></tr></thead>
              <tbody>
                {% for l in limites %}
                <tr>
                  <td>{{ l.id }}</td><td>{{ l.usuario.nombre }}</td><td>{{ l.categoria.nombre }}</td>
                  <td><form action="{{ url_for('admin_controller.editar_limite', id=l.id) }}" method="POST" style="display:inline-flex;"><input type="number" name="limite_minutos" value="{{ l.limite_minutos }}" required min="1" style="width: 60px;"><button type="submit" style="margin-left: 5px;">üíæ</button></form></td>
                  <td><form action="{{ url_for('admin_controller.eliminar_limite', id=l.id) }}" method="POST" style="display:inline;"><button type="submit" onclick="return confirm('¬øEliminar l√≠mite?')">üóëÔ∏è</button></form></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      </section>

      <section class="tile-box status-limit-box">
          <h3>ESTADO DE L√çMITES HOY</h3>
          <div class="table-container scrollable-content">
            <table>
              <thead><tr><th>Categor√≠a</th><th>L√≠mite</th><th>Usado hoy</th><th>Estado</th></tr></thead>
              <tbody>
                {% for limite in estado_limites %}
                <tr>
                  <td>{{ limite.categoria }}</td><td>{{ limite.limite }}</td><td>{{ limite.usado }}</td>
                  <td>{% if limite.excedido %}<span class="estado-rojo">‚ö†Ô∏è Excedido</span>{% else %}<span class="estado-verde">‚úì En rango</span>{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      </section>

    </div>
  </main>
</div>



  <!-- Men√∫ flotante -->
  <div id="menuFlotanteConfig" class="config-dropdown hidden">
    <div class="tile-box menu-box">
      <h2 class="menu-title">Configuraci√≥n de la cuenta</h2>

      <button onclick="window.location.href='/admin/categorias'" class="menu-button">
        üóÇÔ∏è Administrar dominios y categor√≠as
      </button>

      <hr class="menu-separator">

      <div class="menu-section">
        <label for="rango-exportar">Rango de tiempo para exportar:</label> 
        <select id="rango-exportar" class="menu-select"> 
          <option value="3dias">√öltimos 3 d√≠as</option>
          <option value="15dias">√öltimos 15 d√≠as</option>
          <option value="mes">√öltimo mes</option>
          <option value="3meses">√öltimos 3 meses</option>
          <option value="todo" selected>Todo el tiempo</option>
        </select>

        <div class="menu-buttons-group">
          <button id="bck_btn" class="menu-button-small">Descargar Backup Completo</button>
          <button id="exportarCSV" class="menu-button-small">üìÑ Exportar CSV</button>
          <button id="exportarJSON" class="menu-button-small">üßæ Exportar JSON</button>
        </div>
      </div>

      <hr class="menu-separator">

      <div class="menu-section">
        <label>Restaurar cuenta (.JSON)</label>
        <form id="form-restaurar" enctype="multipart/form-data" class="restore-form">
          <input type="file" id="archivo-backup" name="backup" accept=".json" required>
          <button type="submit" class="menu-button-small btn-restore">üîì Restaurar Backup</button>
        </form>
      </div>

      <hr class="menu-separator">

      <div class="menu-section">
        <label>Reiniciar cuenta</label>
        <button id="btn-reseteo-total" class="menu-button btn-danger">Reiniciar Cuenta desde Cero</button>
      </div>
    </div>
  </div>

<div id="toast-container" style="position:fixed;right:16px;bottom:16px;z-index:9999"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/coach_toast.js') }}"></script>
<script>
  if (!window.__coachPollingStarted) {
    window.__coachPollingStarted = true;
    checkCoachAlertas();
    window.__coachPolling = setInterval(checkCoachAlertas, 5 * 60 * 1000);
  }
</script>
<script src="{{ url_for('static', filename='js/metas.js') }}"></script>
<script src="{{ url_for('static', filename='js/temas.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  <script src="{{ url_for('static', filename='js/reset_back.js') }}"></script>
</body>
</html>